name: READ BOM
on:
  push:
    branches:
    - main
    - release-* 
  workflow_dispatch:
    # Inputs the workflow accepts.
    inputs:
      version:
        # Friendly description to be shown in the UI instead of 'name'
        description: 'Spinnaker Version'
        # Default value if no value is explicitly provided
        default: '1.30.1'
        # Input has to be provided for the workflow to run
        required: true
        # The data type of the input
        type: string
env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Xmx6g -Xms6g
  CONTAINER_REGISTRY: quay.io/opsmxpublic
  
jobs:
  get-bom:
    runs-on: ubuntu-latest
    outputs:
      cloudriver-version: ${{ steps.get-bom.outputs.cloudriver-version }}
    if: ${{ true }}
    steps:
    - name: Checkout OpsMx clouddriver repo
      uses: actions/checkout@v3
    - id: get-bom
      run: |
            wget https://storage.googleapis.com/halconfig/bom/${{ inputs.version }}.yml 

            cat ${{ inputs.version }}.yml  | yq '.services.clouddriver.version' 
            
            imageVersion=${{ cat ${{ inputs.version }}.yml  | yq '.services.clouddriver.version' }}
            echo "cloudriver-version=$imageVersion" >> $GITHUB_OUTPUT


  build-clouddriver:
    runs-on: ubuntu-latest
    outputs:
      clouddriver: ${{ steps.get-build-name.outputs.clouddriver }}
    if: ${{ true }}
    steps:
    - name: Checkout OpsMx clouddriver repo
      uses: actions/checkout@v3
      with:
        repository: opsmx/clouddriver
        ref: refs/heads/${{ needs.get-bom.outputs.cloudriver-version }}
    - uses: actions/setup-java@v3
      with:
        distribution: zulu
        java-version: 11
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - name: Prepare build variables
      id: build_variables
      run: |
          echo ::set-output name=REPO::"ubi8-clouddriver"
          echo ::set-output name=VERSION::"$(git rev-parse --short HEAD)-$(date --utc +'%Y%m%d%H%M')"

          ls -ltra

          git branch 


          git log -1
          

            
